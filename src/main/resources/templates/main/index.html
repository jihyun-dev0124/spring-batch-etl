<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>배치 실행 현황</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <style>
        .kpi-card { border-radius: 12px; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        .truncate { max-width: 360px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    </style>
</head>
<body class="bg-light">
<div class="container-fluid py-4">

    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
            <h4 class="mb-0">배치 실행 현황</h4>
            <div class="text-secondary small">Job/Step 실행 요약을 기반으로 상태·처리량·실패를 모니터링합니다.</div>
        </div>
    </div>

    <!-- KPI Row (선택: 있으면 운영이 편함) -->
    <div class="row g-3 mb-4">
        <div class="col-12 col-md-3">
            <div class="card kpi-card shadow-sm">
                <div class="card-body">
                    <div class="text-secondary small">오늘 실행</div>
                    <div class="fs-4 fw-semibold" th:text="${kpi.todayTotal}">0</div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-3">
            <div class="card kpi-card shadow-sm">
                <div class="card-body">
                    <div class="text-secondary small">오늘 실패</div>
                    <div class="fs-4 fw-semibold" th:text="${kpi.todayFailed}">0</div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-3">
            <div class="card kpi-card shadow-sm">
                <div class="card-body">
                    <div class="text-secondary small">재처리 대기(에러로그)</div>
                    <div class="fs-4 fw-semibold" th:text="${kpi.pendingRetryRows}">0</div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-3">
            <div class="card kpi-card shadow-sm">
                <div class="card-body">
                    <div class="text-secondary small">평균 소요(초)</div>
                    <div class="fs-4 fw-semibold" th:text="${#numbers.formatDecimal(kpi.avgDurationSec, 1, 1)}">0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter -->
    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <form class="row g-2 align-items-end" method="get" th:action="@{/admin/batch/executions}">
                <div class="col-12 col-md-2">
                    <label class="form-label small text-secondary">기간 시작</label>
                    <input type="date" class="form-control" name="fromDate" th:value="${condition.fromDate != null ? condition.fromDate : ''}"/>
                </div>
                <div class="col-12 col-md-2">
                    <label class="form-label small text-secondary">기간 종료</label>
                    <input type="date" class="form-control" name="toDate" th:value="${condition.toDate != null ? condition.toDate : ''}"/>
                </div>

                <div class="col-12 col-md-2">
                    <label class="form-label small text-secondary">도메인</label>
                    <select class="form-select" name="domainType">
                        <option value="" th:selected="${condition.domainType == null || condition.domainType == ''}">전체</option>
                        <option value="MEMBER" th:selected="${condition.domainType == 'MEMBER'}">MEMBER</option>
                        <option value="ORDER" th:selected="${condition.domainType == 'ORDER'}">ORDER</option>
                        <option value="SALES" th:selected="${condition.domainType == 'SALES'}">SALES</option>
                    </select>
                </div>

                <div class="col-12 col-md-2">
                    <label class="form-label small text-secondary">상태</label>
                    <select class="form-select" name="status">
                        <option value="" th:selected="${condition.status == null || condition.status == ''}">전체</option>
                        <option value="COMPLETED" th:selected="${condition.status == 'COMPLETED'}">COMPLETED</option>
                        <option value="FAILED" th:selected="${condition.status == 'FAILED'}">FAILED</option>
                        <option value="STOPPED" th:selected="${condition.status == 'STOPPED'}">STOPPED</option>
                    </select>
                </div>

                <div class="col-12 col-md-2">
                    <label class="form-label small text-secondary">mallId</label>
                    <input type="number" class="form-control" name="mallId" placeholder="예: 3" th:value="${condition.mallId}"/>
                </div>

                <div class="col-12 col-md-2 d-flex gap-2">
                    <button type="submit" class="btn btn-primary w-100">검색</button>
                    <a class="btn btn-outline-secondary w-100" th:href="@{/admin/batch/executions}">초기화</a>
                </div>

                <!-- 페이징 유지용 -->
                <input type="hidden" name="page" th:value="${page.pageNo}"/>
                <input type="hidden" name="size" th:value="${page.size}"/>
            </form>
        </div>
    </div>

    <!-- Table -->
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-secondary small">
                    총 <span th:text="${page.totalElements}">0</span>건
                </div>
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm" style="width: 120px;"
                            onchange="location.href=this.value;">
                        <option th:value="@{/admin/batch/executions(size=20, page=0, fromDate=${condition.fromDate}, toDate=${condition.toDate}, domainType=${condition.domainType}, status=${condition.status}, mallId=${condition.mallId})}"
                                th:selected="${page.size == 20}">20개</option>
                        <option th:value="@{/admin/batch/executions(size=50, page=0, fromDate=${condition.fromDate}, toDate=${condition.toDate}, domainType=${condition.domainType}, status=${condition.status}, mallId=${condition.mallId})}"
                                th:selected="${page.size == 50}">50개</option>
                        <option th:value="@{/admin/batch/executions(size=100, page=0, fromDate=${condition.fromDate}, toDate=${condition.toDate}, domainType=${condition.domainType}, status=${condition.status}, mallId=${condition.mallId})}"
                                th:selected="${page.size == 100}">100개</option>
                    </select>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle" style="width: 1560px">
                    <colgroup>
                        <col width="180px" />
                        <col width="180px" />
                        <col width="80px" />
                        <col width="180px" />
                        <col width="180px" />
                        <col width="130px" />
                        <col width="60px" />
                        <col width="130px" />
                        <col width="80px" />
                        <col width="80px" />
                        <col width="80px" />
                        <!--<col width="360px" />-->
                        <col width="200px" />
                    </colgroup>
                    <thead class="table-light">
                    <tr>
                        <th>시작</th>
                        <th>종료</th>
                        <th>소요</th>
                        <th>Job</th>
                        <th>Step</th>
                        <th>도메인</th>
                        <th>mallId</th>
                        <th>상태</th>
                        <th class="text-end">read</th>
                        <th class="text-end">write</th>
                        <th class="text-end">skip</th>
                        <!--<th>메시지</th>-->
                        <th class="text-center">액션</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${#lists.isEmpty(summaries)}">
                        <td colspan="13" class="text-center text-secondary py-5">조회 결과가 없습니다.</td>
                    </tr>

                    <tr th:each="s : ${summaries}">
                        <td class="small mono" th:text="${#temporals.format(s.startTime, 'yyyy-MM-dd HH:mm:ss')}">2025-12-15T10:00:00</td>
                        <td class="small mono" th:text="${#temporals.format(s.endTime, 'yyyy-MM-dd HH:mm:ss')}">2025-12-15T10:03:12</td>
                        <td class="small" th:text="${s.durationSec + 's'}">0s</td>

                        <td class="mono" th:text="${s.jobName}">memberSyncJob</td>
                        <td class="mono" th:text="${s.stepName}">memberSyncStep</td>

                        <td><span class="badge text-bg-secondary" th:text="${s.domainType}">MEMBER</span></td>
                        <td th:text="${s.mallId}">3</td>

                        <td>
                          <span class="badge"
                                th:classappend="${s.status == 'FAILED'} ? ' text-bg-danger' : (${s.status == 'COMPLETED'} ? ' text-bg-success' : ' text-bg-warning')"
                                th:text="${s.status}">COMPLETED</span>
                        </td>

                        <td class="text-end mono" th:text="${s.readCount}">0</td>
                        <td class="text-end mono" th:text="${s.writeCount}">0</td>
                        <td class="text-end mono" th:text="${s.skipCount}">0</td>

                        <!--<td class="truncate text-secondary small" th:text="${s.exitMessage}">-</td>-->

                        <td class="text-end">
                            <a class="btn btn-sm btn-outline-primary"
                               th:href="@{/admin/batch/executions/{id}(id=${s.id})}">
                                상세
                            </a>
                            <a class="btn btn-sm btn-outline-secondary"
                               th:href="@{/admin/batch/errors(fromDate=${condition.fromDate},toDate=${condition.toDate},domainType=${s.domainType},mallId=${s.mallId},jobName=${s.jobName},stepName=${s.stepName})}">
                                에러
                            </a>
                            <a class="btn btn-sm btn-outline-danger retry-job"
                               href="javascript:"
                               th:if="${s.status == 'FAILED' and s.retryFlag == 1}"
                               th:data-job-execution-id="${s.jobExecutionId}">
                                재실행요청
                            </a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <nav th:if="${page.totalPages > 1}">
                <ul class="pagination justify-content-center mb-0">
                    <li class="page-item" th:classappend="${page.pageNo == 0} ? ' disabled'">
                        <a class="page-link"
                           th:href="@{/admin/batch/executions(page=${page.pageNo-1},size=${page.size},fromDate=${condition.fromDate},toDate=${condition.toDate},domainType=${condition.domainType},status=${condition.status},mallId=${condition.mallId})}">
                            이전
                        </a>
                    </li>

                    <li class="page-item"
                        th:each="p : ${#numbers.sequence(0, page.totalPages-1)}"
                        th:classappend="${p == page.pageNo} ? ' active'">
                        <a class="page-link"
                           th:text="${p+1}"
                           th:href="@{/admin/batch/executions(page=${p},size=${page.size},fromDate=${condition.fromDate},toDate=${condition.toDate},domainType=${condition.domainType},status=${condition.status},mallId=${condition.mallId})}">
                            1
                        </a>
                    </li>

                    <li class="page-item" th:classappend="${page.pageNo >= page.totalPages-1} ? ' disabled'">
                        <a class="page-link"
                           th:href="@{/admin/batch/executions(page=${page.pageNo+1},size=${page.size},fromDate=${condition.fromDate},toDate=${condition.toDate},domainType=${condition.domainType},status=${condition.status},mallId=${condition.mallId})}">
                            다음
                        </a>
                    </li>
                </ul>
            </nav>

        </div>
    </div>

</div>

<script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    $(function(){
        $(".retry-job").on("click", function(){
            const jobExecutionId = $(this).data("jobExecutionId");
            console.log(jobExecutionId);
            $.ajax({
                type: "get",
                url: "batch/retry-requests/new",
                data: "jobExecutionId="+jobExecutionId,
                success: function(result){
                    console.log(result);
                    if(!result.retryResult){
                        alert("배치 재시도에 실패하였습니다.");
                    }
                },
                error: function (e) {
                    console.log(e);
                },
            })

        });

    });
</script>
</body>
</html>
